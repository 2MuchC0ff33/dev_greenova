{% load static %}
{% load user_tags %}
{% load core_tags %}
{% load dashboard_tags %}
{% load custom_filters %}

<!-- Persistent htmx indicator for partial swaps (hidden, ARIA-compliant) -->
<div id="htmx-indicator" class="htmx-indicator" aria-hidden="true" hidden>
  <div class="loading-spinner" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- Ensure project-selector is present for all htmx-include references -->
<div hidden aria-hidden="true" tabindex="-1">
{% include "projects/projects_selector.html" %}
</div>

<!-- Dashboard content that will be swapped when a project is selected -->
<!-- This contains ONLY the charts and data tables, not structural elements -->

<!-- Dashboard Summary Cards -->
<section class="dashboard-metrics"
         aria-label="Dashboard Summary"
         id="dashboard-metrics-container"
         data-hx-preserve="true">
  <div class="card metric-card card-status-danger">
    <div class="card-body">
      <h3 class="metric-card-label">
Overdue Obligations
      </h3>
      <div class="metric-card-value">
{{ overdue_obligations_count|default:"0" }}
      </div>
      <div class="metric-card-trend">
        <span class="trend-indicator"></span>
        <span class="trend-down">Overdue</span>
      </div>
    </div>
  </div>

  <div class="card metric-card card-status-primary">
    <div class="card-body">
      <h3 class="metric-card-label">
Active Obligations
      </h3>
      <div class="metric-card-value">
{{ active_obligations_count|default:"120" }}
      </div>
      <div class="metric-card-trend">
        <span class="trend-indicator"></span>
        {% if active_obligations_trend > 0 %}
          <span class="trend-up">↑ {{ active_obligations_trend }}% from last month</span>
        {% elif active_obligations_trend < 0 %}
          <span class="trend-down">↓ {{ active_obligations_trend|abs_value }} % from last month</span>
        {% else %}
          <span class="trend-neutral">No change from last month</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card metric-card card-status-warning">
    <div class="card-body">
      <h3 class="metric-card-label">
Upcoming Deadlines
      </h3>
      <div class="metric-card-value">
{{ upcoming_deadlines_count|default:"15" }}
      </div>
      <div class="metric-card-trend">
within 7 days
      </div>
    </div>
  </div>

  <div class="card metric-card card-status-success">
    <div class="card-body">
      <h3 class="metric-card-label">
Projects Overview
      </h3>
      <div class="metric-card-value">
{{ active_projects_count|default:"1" }}
      </div>
      <div class="metric-card-trend">
Active Projects
      </div>
    </div>
  </div>

</section>

<!-- Only render the environmental mechanisms analysis card, its chart, and table -->
<div id="data-containers"
     data-hx-ext="class-tools"
     class="dashboard-charts">
  <!-- Mechanisms Chart -->
  <div id="mechanism-data-container"
       class="card chart-container"
       hx-get="{% url 'mechanisms:mechanism_charts' %}"
       hx-trigger="load"
       hx-include="#project-selector"
       hx-target="#mechanism-data-container"
       hx-swap="innerHTML">
    <div class="loading-indicator">
      <span class="loading-spinner"></span>
      <p>
Loading chart data...
      </p>
    </div>
  </div>
</div>
